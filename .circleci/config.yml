version: 2.1

setup: true

defaults: &defaults
  working_directory: /tmp/ci-test

orbs:
  continuation: circleci/continuation@0.1.2
  aws-cli: circleci/aws-cli@3.1

executors:
  version-check:
    docker:
      - image: amazonlinux:2

jobs:
  evaluate:
    <<: *defaults
    executor: version-check
    environment:
      AWS_DEFAULT_REGION: us-east-1
    steps:
      - run: mkdir -p workspace
      - run: |
          yum update -y
          yum install tar -y && yum install gzip -y && yum install unzip -y
          yum makecache fast
          export CLAMAV_LATEST=$(yum info clamav-update | grep Version | awk -F':' '{ print $2 }' | tail -n1 | tr -d '[:space:]')
          echo '{"clamav-version": "'$CLAMAV_LATEST'" }' >> workspace/clamav-latest.json
      - aws-cli/setup:
          role-arn: $CIRCLECI_ROLE_ARN
      - run: |
          aws s3 ls s3://$S3_BUCKET/lambda-$CLAMAV_LATEST.zip
          if [[ $? == 0 ]]; then export REQUIRE_UPDATE=true; else; exit 0; fi
          echo '{"require-update": "'$REQUIRE_UPDATE'"}' >> workspace/require-update.json
      - persist_to_workspace:
          root: workspace
          paths:
            - clamav-latest.json
            - require-update.json

  setup:
    <<: *defaults
    executor: continuation/default
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/ci-test/workspace
      - run:
          name: use job config
          command: |
            ./scripts/new-config
      - continuation/continue:
          configuration_path: ./configs/generated_config.yml
          parameters: /tmp/ci-test/workspace/require-update.json

workflows:
  version: 2
  load-env-setup:
    jobs:
      - evaluate:
          context:
            - aws
      - setup:
          requires:
            - evaluate